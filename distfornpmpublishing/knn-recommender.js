!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["knn-recommender"]=t():e["knn-recommender"]=t()}(this,(function(){return(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{default:()=>r});class r{constructor(e){this.userToUserSimilarityMap={},this.userToRowNumberMap={},this.itemIdToColumnNumberMap={},this.initialized=!1,e?(this.checkUserItemMatrix(e),this.userItemMatrix=e):(console.warn("Warning: Initializing knn-recommender with an empty user item matrix"),this.userItemMatrix=new Array(new Array),this.userItemMatrix[0].push("emptycorner"))}checkUserItemMatrix(e){if(!e||!e[0]||e[0].constructor!==Array||"string"!=typeof e[0][1])throw new TypeError("Malformatted user item matrix. It should be a non zero two dimensional array in the format [['emptycorner', 'item 1', 'item 2', 'item 3'], ['user 1', 1, -1, 0], ['user 2', 0, -1, 1]]")}initializeRecommender(){return new Promise(((e,t)=>{this.userToRowNumberMap={},this.itemIdToColumnNumberMap={},this.calculateDistancesInZeroOneUserItemMatrixAndCreateUserToRowAndItemToColumnMapInChunks().then((t=>{this.initialized=!0,e(t)})).catch((e=>{t(e)}))}))}initializeRecommenderForUserId(e){this.userToRowNumberMap[e]=0;for(let t=0;t<this.userItemMatrix.length;t++)if(this.userItemMatrix[t][0]===e)return this.calculateDistancesInZeroOneUserItemMatrixAndCreateUserToRowAndItemToColumnMap(t,t+1),void(this.initialized=!0);throw Error(`UserId ${e} not found in user item matrix!`)}getNNearestNeighboursForUserId(e,t=-1){this.checkInitiated();let r=this.userToUserSimilarityMap[e];if(!r)throw Error(`User similarities no initialized for userId: ${e}`);return-1!==t&&r.length>t?r.slice(0,t):r}generateNNewRecommendationsForUserId(e,t=1,r=3){return this.checkInitiated(),this.generateNNewRecommendationsForUserIdInternal(e,!1,t,r)}generateNNewUniqueRecommendationsForUserId(e,t=1,r=3){return this.checkInitiated(),this.generateNNewRecommendationsForUserIdInternal(e,!0,t,r)}addLikeForUserToAnItem(e,t){this.updateUserItemMatrixForUserId(e,t,1)}addDislikeForUserToAnItem(e,t){this.updateUserItemMatrixForUserId(e,t,-1)}updateUserItemMatrixForUserId(e,t,r){if(!this.userToRowNumberMap[e]||!this.itemIdToColumnNumberMap[t])throw new Error("userId or itemId not valid when updating user's value. Have you initialized the recommender after adding new items or users?");this.userItemMatrix[this.userToRowNumberMap[e]][this.itemIdToColumnNumberMap[t]]=r}addNewUserToDataset(e){if(!e||e.length!=this.userItemMatrix[0].length)throw new Error("The user row to be added doesn't have the same amount of columns as the current user item matrix");if("string"!=typeof e[0])throw new Error("The user row to be added isn't in the correct format that should be ['user id', 0, 1, ...]");if(this.userToRowNumberMap[e[0]])throw new Error(`A row for the given userid: ${e[0]} already exists in the user item matrix. Can't add a second row for the same user id. `);this.userToRowNumberMap[e[0]]=this.userItemMatrix.push(e)-1}addNewEmptyUserToDataset(e){let t=new Array(this.userItemMatrix[0].length);t[0]=e;for(let e=1;e<this.userItemMatrix[0].length;e++)t[e]=0;this.addNewUserToDataset(t)}addNewItemToDataset(e){this.itemIdToColumnNumberMap[e]=this.userItemMatrix[0].push(e)-1;for(let e=1;e<this.userItemMatrix.length;e++)this.userItemMatrix[e].push(0)}getAllRecommendationsForUserId(e){const t=this.userToRowNumberMap[e];if(!t)throw new Error(`Invalid or non initialized user id ${e}`);return this.userItemMatrix[t]}generateNNewRecommendationsForUserIdInternal(e,t,r=1,i=3){const s=this.getAllRecommendationsForUserId(e),o=this.getNNearestNeighboursForUserId(e,i);let a=new Array(r),n=0,m={};for(let e=0;e<o.length;e++){const i=this.getAllRecommendationsForUserId(o[e].otherUserId);for(let u=1;u<s.length;u++)if(!(t&&m[u]||1!==i[u]||0!==s[u])){if(a[n]={itemId:this.userItemMatrix[0][u],recommenderUserId:o[e].otherUserId,similarityWithRecommender:o[e].similarity},n++,n>=r)return a;m[u]=!0}}return a}checkInitiated(){if(!this.initialized)throw new Error("Recommender not initialized!")}calculateDistancesInZeroOneUserItemMatrixAndCreateUserToRowAndItemToColumnMapInChunks(){return new Promise(((e,t)=>{this.chunkIntermediator(1,this.userItemMatrix.length,e,t)}))}chunkIntermediator(e,t,r,i){const s=e+3>t?t:e+3;try{this.calculateDistancesInZeroOneUserItemMatrixAndCreateUserToRowAndItemToColumnMap(e,s)}catch(e){return void i(e)}s<t?setTimeout((()=>this.chunkIntermediator(e+3,t,r,i)),0):(this.initialized=!0,r(!0))}calculateDistancesInZeroOneUserItemMatrixAndCreateUserToRowAndItemToColumnMap(e,t){const r=this.userItemMatrix.length,i=this.userItemMatrix[0].length;let s=!1;for(let o=e;o<t;o++){let e=Array(r-2),t=0;for(let a=1;a<r;a++){if(o===a)continue;let r=0,n=0;for(let e=1;e<i;e++){if(s||(this.itemIdToColumnNumberMap[this.userItemMatrix[0][e]]=e),-1!==this.userItemMatrix[o][e]&&0!==this.userItemMatrix[o][e]&&1!==this.userItemMatrix[o][e])throw new RangeError(`Element in user item matrix was invalid, either not a number at all or not a -1, 0, or 1. The invalid value  at index [${o}][${e}] is: ${this.userItemMatrix[o][e]}`);0!==this.userItemMatrix[o][e]&&this.userItemMatrix[o][e]===this.userItemMatrix[a][e]?(r++,n++):0===this.userItemMatrix[o][e]&&0===this.userItemMatrix[a][e]||n++}s=!0;let m=0!==n?r/n:0;if("string"!=typeof this.userItemMatrix[a][0])throw new TypeError(`Malformatted user item matrix. Element atat index [${a}][0] is not a string (describing a userid). The invalid element is: ${this.userItemMatrix[a][0]}`);e[t]={otherUserId:this.userItemMatrix[a][0],similarity:m},t++}if("string"!=typeof this.userItemMatrix[o][0])throw new TypeError(`Malformatted user item matrix. Element atat index [${o}][0] is not a string (describing a userid). The invalid element is: ${this.userItemMatrix[o][0]}`);if(this.userToRowNumberMap[this.userItemMatrix[o][0]])throw new Error(`Malformatted user item matrix. The matrix contains two users with the same id: ${this.userItemMatrix[o][0]}`);this.userToRowNumberMap[this.userItemMatrix[o][0]]=o,this.userToUserSimilarityMap[this.userItemMatrix[o][0]]=this.sortUserToOtherUsersSimilarityListByUserToUserSimilarityDescending(e)}}sortUserToOtherUsersSimilarityListByUserToUserSimilarityDescending(e){return e.sort(((e,t)=>e.similarity>t.similarity?-1:1))}}return t})()}));